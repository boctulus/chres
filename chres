#!/bin/bash

loadconf () {
	local real=$(realpath $0)
	base=$(dirname $real)
	source $base/chres.conf
}

get_resols () {
	declare -A local _arr
	_arr=()

	local minw=$(echo $minres | cut -d'x' -f1)
	local minh=$(echo $minres | cut -d'x' -f2)

	local resols=$(xrandr | egrep -o '[0-9]{3,}+x[0-9]{3,}')

	local ix=0
	local res
	for res in ${resols[@]}; do
		local _ratio=$(echo "scale=1; $res" | awk '{print $1,"/",$2}' FS="x" | bc -l)
		local _w=$(echo $res | cut -d'x' -f1)
		local _h=$(echo $res | cut -d'x' -f2)

		if [[ ! -z $ratio ]]; then
			if [[ $(echo $ratio | bc -l) == $(echo $_ratio | bc -l) ]]; then
				if [[ ! -z $minres ]]; then
					[[ $_w -ge $minw ]] && [[ $_h -ge minh ]] && _arr[$res]+=1
				else
					_arr[$res]+=1
				fi			
			fi
		else
			if [[ ! -z $minres ]]; then
				[[ $_w -ge $minw ]] && [[ $_h -ge minh ]] && _arr[$res]+=1
			else
				_arr[$res]+=1
			fi		
		fi			
		
		((ix++))
	done

	for res in ${!_arr[@]}; do
		selected_resols=(${selected_resols[@]} $res)	
	done

	IFS=$'\n' selected_resols=($(sort -r <<<"${selected_resols[*]}"))
	unset IFS
}


reset () {
	DISPLAY=$screen xrandr --output $display --auto
}

set_resol () {
	local wxh=$1

	[[ $wxh == "default" ]] && { reset; return; }

	local wh=$(echo $wxh | awk '{print $1,$2}' FS="x")
	local params=$(cvt $wh $frec | grep ^Modeline | cut -d' ' -f3-)
	set -- $params

	xrandr --newmode "${wxh}_$frec.00" $@ 2>/dev/null
	xrandr --addmode $display ${wxh}_$frec.00 2>/dev/null
	xrandr --output $display --mode ${wxh}_$frec.00 2>/dev/null
}

get_display () {
	set -- $(xrandr | grep ' connected' | egrep -o -i ^[a-z][a-z0-9\-]*)

	case $# in 
		0)
			echo There is no 'display' connected
			exit
			;;
		1)	
			display=$1
			;;
		*)
			echo -e "Select display \n"

			select display in $@
			do
				break	
			done	
	esac 
}

get_alias () {
	shopt -s nocasematch
	case $1 in
		SD|240p)
			echo 352x240
			;;
		360p)
			echo 480x360
			;;
		480p)
			echo 858x480
			;;
		HALF-HD|720p)
			echo 1280x720
			;;
		FULL-HD|1080p)
			echo 1920x1080
			;;
		ULTRA-HD|4K|2160p)
			echo 3860x2160
			;;	
		*)
			return 1				
	esac
	return 0
}


# Load settings
loadconf

# Try with aliases
if [[ -z $(egrep '[1-3]\.[0-9]+' <<< $ratio) ]]; then
	if [[ ! -z $(egrep '[0-9]{1,4}:[0-9]{1,4}' <<<$ratio) ]]; then
		IFS=':'	
		set -- $ratio
		unset IFS
		ratio=$(echo "scale=1; $1/$2" | bc -l)
	else
		res=$(get_alias $ratio);
		ratio=$(echo "scale=1; $res" | awk '{print $1,"/",$2}' FS="x" | bc -l)
	fi	
fi 

if [[ -z $(egrep '[0-9]{3,}x[0-9]{3,}' <<< $minres) ]]; then 
	minres=$(get_alias $minres)
fi	


# Get / select display
get_display

# Select automaticaly some resolutions 
get_resols

echo -e "Select resolution \n"

select res in ${selected_resols[@]} default quit
do
	[[ $res == "quit" ]] && break

	echo "Changing to $res"
	sleep 1
	set_resol "$res"
done
